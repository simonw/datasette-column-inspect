{% extends "default:table.html" %}

{% block extra_head %}
<script>

var sidepanel = null;
var table = "{{ table }}";
var base_path = "/{{ database|quote_plus }}";
var table_path = "/{{ database|quote_plus }}/{{ table|quote_plus }}";

var label_columns = [];

window.addEventListener("load", () => {
    var table = document.getElementsByTagName("table")[0];
    // Wrap table in <div><div>TABLE</div><div>SIDEBAR</div></div>
    var wrapper = document.createElement('div');
    wrapper.style.display = 'flex';
    table.parentNode.insertBefore(wrapper, table);
    var tableDiv = document.createElement('div');
    tableDiv.style.flex = '3 0 0';
    tableDiv.style.overflow = 'auto';
    window.sidepanel = document.createElement('div');
    window.sidepanel.style.maxWidth='300px';
    window.sidepanel.style.flex = '1 0 0';
    window.sidepanel.style.marginTop = '-1em';
    window.sidepanel.style.boxShadow = '0 30px 40px rgba(0,0,0,.2)';
    window.sidepanel.style.padding = '1em';
    window.sidepanel.style.border = '2px solid #ccc';
    wrapper.appendChild(tableDiv);
    wrapper.appendChild(window.sidepanel);
    tableDiv.appendChild(table);

    // Make the ths clickable
    Array.from(table.getElementsByTagName("th")).forEach(th => {
        th.style.backgroundColor = '#ccc';
        th.style.padding = '10px 8px';
        th.style.cursor = 'pointer';
        // Figure out first two columns for display later
        var a = th.getElementsByTagName("a")[0];
        if (!a) {
            // Link column
            return true;
        }
        var column = decodeURIComponent(a.href.split("=")[1].replace(/\+/g, ' '));
        if (column != "rowid" && label_columns.length < 1) {
            label_columns.push(column);
        }
        th.addEventListener("click", () => {
            inspectColumn(column);
        });
    });
    // render(html, sidepanel);
    window.sidepanel.innerHTML = `<strong>&#11013;&nbsp; Select a column</strong>`;
});

function query(sql) {
    var url = base_path + '.json?_shape=array&sql=' + encodeURIComponent(sql);
    return fetch(url).then(r => r.json());
}

function inspectColumn(column) {
    window.sidepanel.innerHTML = `<strong>${column}</strong>`;
    var sql = `
        select
            max(cast([${column}] as float)) as max,
            min(cast([${column}] as float)) as min,
            avg(cast([${column}] as float)) as mean,
            stdev(cast([${column}] as float)) as stdev,
            count(distinct [${column}]) as uniques
        from [${table}]
    `;
    query(sql).then(rows => {
        var stats = rows[0];
        window.sidepanel.innerHTML += `
        <p><span style="display: block; font-size: 0.65em">Min:</span>${stats.min.toFixed(3)}<br>
        <span style="display: block; font-size: 0.65em">Max:</span>${stats.max.toFixed(3)}<br>
        <span style="display: block; font-size: 0.65em">Mean:</span>${stats.mean.toFixed(3)}<br>
        <span style="display: block; font-size: 0.65em">Stdev:</span>${stats.stdev.toFixed(3)}<br>
        <span style="display: block; font-size: 0.65em">Unique values:</span>${stats.uniques}</p>
        `;
        // Outlier cutoff is 3xstdev
        var cutoff = 3 * stats.stdev;
        var lower = stats.mean - cutoff;
        var upper = stats.mean + cutoff;
        var lower_sql = `
            select * from [${table}]
            where cast([${column}] as float) < ${lower}
        `;
        var upper_sql = `
            select * from [${table}]
            where cast([${column}] as float) > ${upper}
        `;
        query(lower_sql).then(rows => {
            if (rows.length) {
                var html = `
                    <p><span style="display: block; font-size: 0.65em">Outliers, low:</span>
                `;
                rows.forEach(row => {
                    // For the moment display first two columns
                    label_columns.forEach(label_column => {
                        html += label_column + ": " + row[label_column] + '<br>'
                    });
                    html += '<strong style="display: block; border-bottom: 1px solid #ccc">' + column + ": " + row[column] + '</strong>';
                });
                var where = `cast([${column}] as float) < ${lower}`;
                html += `<p><a href="${base_path}/${encodeURIComponent(table)}?_where=${encodeURIComponent(where)}">View these outliers</a></p>`;
                window.sidepanel.innerHTML += html;
            }
        });
        query(upper_sql).then(rows => {
            if (rows.length) {
                var html = `
                    <p><span style="display: block; font-size: 0.65em">Outliers, high:</span>
                `;
                rows.forEach(row => {
                    // For the moment display first two columns
                    label_columns.forEach(label_column => {
                        html += label_column + ": " + row[label_column] + '<br>'
                    });
                    html += '<strong style="display: block; border-bottom: 1px solid #ccc">' + column + ": " + row[column] + '</strong>';
                });
                var where = `cast([${column}] as float) > ${upper}`;
                html += `<p><a href="${base_path}/${encodeURIComponent(table)}?_where=${encodeURIComponent(where)}">View these outliers</a></p>`;
                window.sidepanel.innerHTML += html;
            }
        });
        // Find most and least used columns
        var most_least_sql = `
            with top_values as (
                select
                    'top' as bunch,
                    [${column}] as value,
                    count(*) as num
                from
                    [${table}]
                group by
                    value
                order by
                    num desc
                limit
                    5
                ),
            bottom_values as (
                select
                    'bottom' as bunch,
                    [${column}] as value,
                    count(*) as num
                from
                    [${table}]
                group by
                    value
                order by
                    num
                limit
                    5
                )
            select * from top_values
                union
            select * from bottom_values
            order by bunch desc, num desc;
        `;
        query(most_least_sql).then(rows => {
            /* Don't show anything if all numbers are 1 */
            if (!rows.filter(r => r['num'] > 1).length) {
                return;
            }
            var top = rows.filter(r => r['bunch'] == 'top');
            var bottom = rows.filter(r => r['bunch'] == 'bottom');
            var html = `<p><span style="display: block; font-size: 0.65em">Most common:</span>`;
            top.forEach(row => {
                html += `<a href="${table_path}?${column}=${encodeURIComponent(row.value)}">${row.value}</a> - ${row.num}<br>`;
            });
            html += `<p><span style="display: block; font-size: 0.65em">Least common:</span>`;
            bottom.forEach(row => {
                html += `<a href="${table_path}?${column}=${encodeURIComponent(row.value)}">${row.value}</a> - ${row.num}<br>`;
            });
            window.sidepanel.innerHTML += html;
        });
    });
}
</script>
{% endblock %}
